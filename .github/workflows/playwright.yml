##############################################################################
# Playwright CI — Optimized for speed without sacrificing reliability
#
# Pipeline strategy:
#   Stage 1 (fast feedback): Smoke + Critical tests on Chromium only (~3 min)
#   Stage 2 (full regression): All tests on Chromium in parallel (~8 min)
#   Stage 3 (cross-browser): Smoke tests on Firefox + WebKit (~5 min)
#                             — only runs on main branch or release PRs
#
# Env var reference:
#   CI=true            — enables strict mode (forbidOnly, reduced retries)
#   PARALLEL_WORKERS   — Playwright worker count (set to runner vCPU count)
#   CROSS_BROWSER      — activates Firefox + WebKit projects
#   HEADLESS           — always omitted in CI (headless is the default)
##############################################################################

name: Playwright Tests

permissions:
  contents: read

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      grep:
        description: "Tag filter (e.g. @smoke, @regression)"
        required: false
        default: ""
      workers:
        description: "Number of parallel workers"
        required: false
        default: "8"

concurrency:
  # Cancel in-progress runs for the same PR to avoid wasting runner minutes
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Stage 1: Fast smoke + critical gate — runs on every push/PR
  # Fails fast so developers get feedback in under 5 minutes.
  # ─────────────────────────────────────────────────────────────────────────
  smoke:
    name: "Smoke & Critical (Chromium)"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers (Chromium only)
        run: npx playwright install chromium --with-deps

      - name: Run smoke & critical tests
        env:
          CI: "true"
          PARALLEL_WORKERS: ${{ github.event.inputs.workers || '8' }}
          BASE_URL: ${{ secrets.BASE_URL || 'https://mobalytics.gg' }}
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://account.mobalytics.gg' }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          RETRY_COUNT: "2"
        run: |
          GREP="${{ github.event.inputs.grep }}"
          WORKERS="${{ github.event.inputs.workers || '8' }}"
          if [ -n "$GREP" ]; then
            npx playwright test --project=chromium --grep "$GREP" --workers=$WORKERS
          else
            npx playwright test --project=chromium --grep "@smoke|@critical" --workers=$WORKERS
          fi

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: test-results/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────
  # Stage 2: Full regression on Chromium
  # Runs after smoke passes; sharded across 3 machines for speed.
  # ─────────────────────────────────────────────────────────────────────────
  regression:
    name: "Full Regression — Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }}"
    needs: smoke
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false # Allow other shards to complete even if one fails
      matrix:
        shardIndex: [1, 2, 3]
        shardTotal: [3]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers (Chromium only)
        run: npx playwright install chromium --with-deps

      - name: Run regression shard
        env:
          CI: "true"
          PARALLEL_WORKERS: "6"
          BASE_URL: ${{ secrets.BASE_URL || 'https://mobalytics.gg' }}
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://account.mobalytics.gg' }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          RETRY_COUNT: "2"
        run: |
          npx playwright test --project=chromium \
            --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }} \
            --workers=6

      - name: Upload shard results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-shard-${{ matrix.shardIndex }}-results
          path: |
            test-results/
            allure-results/
          retention-days: 14

  # ─────────────────────────────────────────────────────────────────────────
  # Stage 3: Cross-browser smoke — only on main branch or release PRs
  # Keeps the full test matrix out of the hot path.
  # ─────────────────────────────────────────────────────────────────────────
  cross-browser:
    name: "Cross-Browser Smoke (${{ matrix.browser }})"
    needs: smoke
    if: github.ref == 'refs/heads/main' || startsWith(github.head_ref, 'release/')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        browser: [firefox, webkit]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install ${{ matrix.browser }}
        run: npx playwright install ${{ matrix.browser }} --with-deps

      - name: Run cross-browser smoke
        env:
          CI: "true"
          PARALLEL_WORKERS: "4"
          BASE_URL: ${{ secrets.BASE_URL || 'https://mobalytics.gg' }}
          API_BASE_URL: ${{ secrets.API_BASE_URL || 'https://account.mobalytics.gg' }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
          USER_PASSWORD: ${{ secrets.USER_PASSWORD }}
          RETRY_COUNT: "2"
        run: |
          npx playwright test \
            --project=${{ matrix.browser }} \
            --grep "@smoke" \
            --workers=4

      - name: Upload cross-browser results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cross-browser-${{ matrix.browser }}-results
          path: test-results/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────
  # Merge allure results from all shards and publish the report
  # ─────────────────────────────────────────────────────────────────────────
  report:
    name: "Publish Allure Report"
    needs: regression
    if: always()
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download all shard results
        uses: actions/download-artifact@v4
        with:
          pattern: regression-shard-*-results
          merge-multiple: true
          path: allure-results/

      - name: Generate Allure report
        run: ./node_modules/.bin/allure generate allure-results --clean -o allure-report

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: allure-report
          destination_dir: allure
          commit_message: "ci: publish Allure report for run ${{ github.run_number }}"
